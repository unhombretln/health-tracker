<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞–¥–º–∏–Ω—Ç–æ–Ω: –¢—Ä–µ–∫–µ—Ä –ó–¥–æ—Ä–æ–≤—å—è</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Manrope:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #151b2e;
            --bg-card: #1a2235;
            --accent-primary: #00ff88;
            --accent-secondary: #00ccff;
            --accent-warning: #ffaa00;
            --accent-danger: #ff3366;
            --text-primary: #ffffff;
            --text-secondary: #8b9dc3;
            --text-dim: #5a6b8c;
            --border-color: #2a3550;
            --shadow-glow: rgba(0, 255, 136, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(0, 255, 136, 0.03) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.3; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 0.5; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        header {
            margin-bottom: 3rem;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-family: 'Bebas Neue', cursive;
            font-size: 4rem;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 40px var(--shadow-glow);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        .upload-zone {
            background: var(--bg-card);
            border: 3px dashed var(--border-color);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 136, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .upload-zone:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.2);
        }

        .upload-zone:hover::before {
            left: 100%;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: var(--text-dim);
            font-size: 0.95rem;
        }

        input[type="file"] {
            display: none;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            animation: fadeIn 1s ease-out both;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border-color: var(--accent-primary);
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }
        .card:nth-child(4) { animation-delay: 0.4s; }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .card-icon {
            font-size: 1.5rem;
            opacity: 0.6;
        }

        .card-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 3rem;
            line-height: 1;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            animation: fadeIn 1.2s ease-out 0.5s both;
        }

        .chart-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.8rem;
            letter-spacing: 0.05em;
            margin-bottom: 1.5rem;
            color: var(--accent-primary);
        }

        canvas {
            max-width: 100%;
        }

        .workouts-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            animation: fadeIn 1.4s ease-out 0.6s both;
        }

        .workout-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .workout-item:last-child {
            border-bottom: none;
        }

        .workout-item:hover {
            background: rgba(0, 255, 136, 0.05);
            transform: translateX(8px);
        }

        .workout-date {
            font-weight: 600;
            color: var(--text-primary);
        }

        .workout-stats {
            display: flex;
            gap: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.8rem;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-dim);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .clear-btn {
            background: rgba(255, 51, 102, 0.2);
            border: 2px solid var(--accent-danger);
            color: var(--accent-danger);
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Manrope', sans-serif;
            font-size: 0.95rem;
            margin-top: 2rem;
        }

        .clear-btn:hover {
            background: var(--accent-danger);
            color: white;
            transform: scale(1.05);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }

        .notification.info {
            border-color: var(--accent-secondary);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 2px solid var(--accent-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease-out;
        }

        .modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.8rem;
            color: var(--accent-primary);
            margin-bottom: 1rem;
        }

        .modal-text {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Manrope', sans-serif;
            font-size: 0.95rem;
            border: 2px solid;
        }

        .modal-btn-cancel {
            background: transparent;
            border-color: var(--border-color);
            color: var(--text-secondary);
        }

        .modal-btn-cancel:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .modal-btn-confirm {
            background: rgba(255, 51, 102, 0.2);
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        .modal-btn-confirm:hover {
            background: var(--accent-danger);
            color: white;
            transform: scale(1.05);
        }

        .profile-btn {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 2px solid var(--accent-secondary);
            color: var(--accent-secondary);
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Manrope', sans-serif;
            font-size: 0.9rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .profile-btn:hover {
            background: var(--accent-secondary);
            color: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 204, 255, 0.3);
        }

        .profile-form {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input, .form-select {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.8rem;
            color: var(--text-primary);
            font-family: 'Manrope', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-dim);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 255, 136, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.3rem;
        }

        .profile-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.5rem;
            color: var(--accent-primary);
        }

        .hr-zones {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            animation: fadeIn 1.4s ease-out 0.6s both;
        }

        .zone-bar {
            display: flex;
            height: 60px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .zone-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            cursor: pointer;
            border-right: 2px solid var(--bg-primary);
        }

        .zone-segment:last-child {
            border-right: none;
        }

        .zone-segment:hover {
            transform: scaleY(1.1);
            z-index: 10;
        }

        .zone-rest { background: #4a5568; color: #fff; }
        .zone-warmup { background: #6366f1; color: #fff; }
        .zone-fat { background: #10b981; color: #fff; }
        .zone-aerobic { background: #f59e0b; color: #fff; }
        .zone-anaerobic { background: #ef4444; color: #fff; }
        .zone-max { background: #991b1b; color: #fff; }

        .zone-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .zone-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .zone-color {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .zone-info {
            flex: 1;
        }

        .zone-name {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        .zone-range {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .zone-time {
            font-size: 0.85rem;
            color: var(--accent-primary);
            font-weight: 600;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .progress-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .progress-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

        .progress-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .progress-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 2.5rem;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .progress-trend {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .progress-trend.up {
            background: rgba(0, 255, 136, 0.1);
            color: var(--accent-primary);
        }

        .progress-trend.down {
            background: rgba(255, 51, 102, 0.1);
            color: var(--accent-danger);
        }

        .progress-trend.stable {
            background: rgba(0, 204, 255, 0.1);
            color: var(--accent-secondary);
        }

        .benchmark-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .benchmark-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .benchmark-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .benchmark-bar {
            position: relative;
            height: 30px;
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .benchmark-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 15px;
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.8rem;
        }

        .benchmark-value {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--bg-primary);
        }

        .benchmark-comparison {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .health-insights {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            animation: fadeIn 1.6s ease-out 0.7s both;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-left: 3px solid var(--accent-primary);
            background: rgba(0, 255, 136, 0.03);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .insight-content h4 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
            color: var(--accent-primary);
        }

        .insight-content p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .workout-stats {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="profile-btn" id="profileBtn">
            üë§ –ü—Ä–æ—Ñ–∏–ª—å
        </button>

        <header>
            <h1>–¢–†–ï–ö–ï–† –ó–î–û–†–û–í–¨–Ø</h1>
            <div class="subtitle">–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ TCX –∏ GPX –¥–∞–Ω–Ω—ã—Ö</div>
        </header>

        <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">üìä</div>
            <div class="upload-text">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
            <div class="upload-hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: TCX, GPX (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)</div>
            <input type="file" id="fileInput" multiple accept=".tcx,.gpx">
        </div>

        <div style="text-align: center; margin-bottom: 2rem;">
            <button class="clear-btn" id="clearBtn" style="display: none;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                    <div class="card-icon">üè∏</div>
                </div>
                <div class="card-value" id="totalWorkouts">0</div>
                <div class="card-subtitle">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">–°–æ–∂–∂–µ–Ω–æ –∫–∞–ª–æ—Ä–∏–π</div>
                    <div class="card-icon">üî•</div>
                </div>
                <div class="card-value" id="totalCalories">0</div>
                <div class="card-subtitle">–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å</div>
                    <div class="card-icon">üíì</div>
                </div>
                <div class="card-value" id="avgHeartRate">--</div>
                <div class="card-subtitle">–£–¥–∞—Ä–æ–≤ –≤ –º–∏–Ω—É—Ç—É</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">–û–±—â–µ–µ –≤—Ä–µ–º—è</div>
                    <div class="card-icon">‚è±Ô∏è</div>
                </div>
                <div class="card-value" id="totalTime">0—á</div>
                <div class="card-subtitle">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
            </div>
        </div>

        <div class="chart-container" id="chartsContainer" style="display: none;">
            <div class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
            <canvas id="workoutsChart"></canvas>
        </div>

        <div class="chart-container" id="heartRateContainer" style="display: none;">
            <div class="chart-title">üíó –ê–Ω–∞–ª–∏–∑ –ø—É–ª—å—Å–∞</div>
            <canvas id="heartRateChart"></canvas>
        </div>

        <div class="health-insights" id="insights" style="display: none;">
            <div class="chart-title">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∑–¥–æ—Ä–æ–≤—å—é</div>
            <div id="insightsContent"></div>
        </div>

        <div class="hr-zones" id="hrZones" style="display: none;">
            <div class="chart-title">‚ù§Ô∏è –ó–æ–Ω—ã –ø—É–ª—å—Å–∞</div>
            <div class="zone-bar" id="zoneBar"></div>
            <div class="zone-legend" id="zoneLegend"></div>
        </div>

        <div class="progress-grid" id="progressGrid" style="display: none;"></div>

        <div id="benchmarksSection" style="display: none;">
            <div class="chart-container">
                <div class="chart-title">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ª—É—á—à–∏–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏</div>
                <div id="benchmarksContent"></div>
            </div>
        </div>

        <div class="workouts-list" id="workoutsList">
            <div class="chart-title">üìã –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
            <div class="empty-state">
                <div class="empty-icon">üìÅ</div>
                <div>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞</div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
            <div class="modal-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modalCancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirm">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-title">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
            <form class="profile-form" id="profileForm">
                <div class="form-group">
                    <label class="form-label" for="age">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç)</label>
                    <input type="number" class="form-input" id="age" min="10" max="100" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 25">
                </div>
                <div class="form-group">
                    <label class="form-label" for="gender">–ü–æ–ª</label>
                    <select class="form-select" id="gender">
                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                        <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                        <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="weight">–í–µ—Å (–∫–≥)</label>
                    <input type="number" class="form-input" id="weight" min="30" max="200" step="0.1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 70">
                </div>
                <div class="form-group">
                    <label class="form-label" for="height">–†–æ—Å—Ç (—Å–º)</label>
                    <input type="number" class="form-input" id="height" min="100" max="250" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 175">
                </div>
            </form>
            <div class="profile-stats" id="profileStats" style="display: none;">
                <div class="profile-stat">
                    <div class="profile-stat-label">–ò–ú–¢</div>
                    <div class="profile-stat-value" id="bmiValue">--</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-label">–ú–∞–∫—Å. –ø—É–ª—å—Å</div>
                    <div class="profile-stat-value" id="maxHrValue">--</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="profileCancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-confirm" id="profileSave" style="background: rgba(0, 255, 136, 0.2); border-color: var(--accent-primary); color: var(--accent-primary);">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let workoutsData = [];
        let charts = {};
        let userProfile = {
            age: null,
            gender: null,
            weight: null,
            height: null
        };

        // Load profile from localStorage
        function loadProfile() {
            const saved = localStorage.getItem('badmintonProfile');
            if (saved) {
                try {
                    userProfile = JSON.parse(saved);
                    console.log('Profile loaded:', userProfile);
                } catch (e) {
                    console.error('Error loading profile:', e);
                }
            }
        }

        // Save profile to localStorage
        function saveProfile() {
            localStorage.setItem('badmintonProfile', JSON.stringify(userProfile));
            console.log('Profile saved:', userProfile);
        }

        // Calculate BMI
        function calculateBMI(weight, height) {
            if (!weight || !height) return null;
            const heightM = height / 100;
            return (weight / (heightM * heightM)).toFixed(1);
        }

        // Calculate max heart rate
        function calculateMaxHR(age) {
            if (!age) return null;
            return Math.round(220 - age);
        }

        // Get BMI category
        function getBMICategory(bmi) {
            if (bmi < 18.5) return '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π';
            if (bmi < 25) return '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π';
            if (bmi < 30) return '–ò–∑–±—ã—Ç–æ—á–Ω—ã–π';
            return '–û–∂–∏—Ä–µ–Ω–∏–µ';
        }

        // Load profile on startup
        loadProfile();

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Upload handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--accent-primary)';
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.style.borderColor = 'var(--border-color)';
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--border-color)';
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Clear data button
        const clearBtn = document.getElementById('clearBtn');
        const confirmModal = document.getElementById('confirmModal');
        const modalCancel = document.getElementById('modalCancel');
        const modalConfirm = document.getElementById('modalConfirm');

        if (clearBtn) {
            clearBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Clear button clicked - showing modal');
                
                // Show custom modal instead of browser confirm
                confirmModal.classList.add('active');
            });
            console.log('Clear button listener attached successfully');
        } else {
            console.error('Clear button not found!');
        }

        // Modal cancel button
        modalCancel.addEventListener('click', () => {
            console.log('User cancelled clear');
            confirmModal.classList.remove('active');
        });

        // Click outside modal to close
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                console.log('User clicked outside - closing modal');
                confirmModal.classList.remove('active');
            }
        });

        // Modal confirm button - actually clear the data
        modalConfirm.addEventListener('click', () => {
            console.log('User confirmed clear - starting data clear');
            confirmModal.classList.remove('active');
            
            try {
                // Clear data
                workoutsData = [];
                fileInput.value = '';
                console.log('Data arrays cleared');
                
                // Destroy charts
                if (charts && Object.keys(charts).length > 0) {
                    Object.values(charts).forEach(chart => {
                        if (chart && chart.destroy) {
                            chart.destroy();
                        }
                    });
                    charts = {};
                    console.log('Charts destroyed');
                }
                
                // Reset UI
                document.getElementById('totalWorkouts').textContent = '0';
                document.getElementById('totalCalories').textContent = '0';
                document.getElementById('avgHeartRate').textContent = '--';
                document.getElementById('totalTime').textContent = '0—á';
                console.log('Stats reset');
                
                // Hide sections
                document.getElementById('chartsContainer').style.display = 'none';
                document.getElementById('heartRateContainer').style.display = 'none';
                document.getElementById('insights').style.display = 'none';
                clearBtn.style.display = 'none';
                console.log('Sections hidden');
                
                // Reset workouts list
                const listContainer = document.getElementById('workoutsList');
                listContainer.innerHTML = `
                    <div class="chart-title">üìã –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                    <div class="empty-state">
                        <div class="empty-icon">üìÅ</div>
                        <div>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞</div>
                    </div>
                `;
                console.log('Workout list reset');
                
                showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'info');
                console.log('Data cleared successfully');
            } catch (error) {
                console.error('Error during clear:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        });

        // Profile modal
        const profileBtn = document.getElementById('profileBtn');
        const profileModal = document.getElementById('profileModal');
        const profileCancel = document.getElementById('profileCancel');
        const profileSave = document.getElementById('profileSave');
        const profileForm = document.getElementById('profileForm');

        profileBtn.addEventListener('click', () => {
            console.log('Opening profile modal');
            // Load current profile data into form
            document.getElementById('age').value = userProfile.age || '';
            document.getElementById('gender').value = userProfile.gender || '';
            document.getElementById('weight').value = userProfile.weight || '';
            document.getElementById('height').value = userProfile.height || '';
            
            updateProfileStats();
            profileModal.classList.add('active');
        });

        profileCancel.addEventListener('click', () => {
            profileModal.classList.remove('active');
        });

        profileModal.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.classList.remove('active');
            }
        });

        // Update profile stats in real-time
        profileForm.addEventListener('input', updateProfileStats);

        function updateProfileStats() {
            const age = parseInt(document.getElementById('age').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseInt(document.getElementById('height').value);
            
            const profileStats = document.getElementById('profileStats');
            
            if (weight && height) {
                const bmi = calculateBMI(weight, height);
                document.getElementById('bmiValue').textContent = bmi;
                profileStats.style.display = 'grid';
            } else {
                profileStats.style.display = 'none';
            }
            
            if (age) {
                const maxHr = calculateMaxHR(age);
                document.getElementById('maxHrValue').textContent = maxHr;
                profileStats.style.display = 'grid';
            }
        }

        profileSave.addEventListener('click', () => {
            const age = parseInt(document.getElementById('age').value) || null;
            const gender = document.getElementById('gender').value || null;
            const weight = parseFloat(document.getElementById('weight').value) || null;
            const height = parseInt(document.getElementById('height').value) || null;
            
            userProfile = { age, gender, weight, height };
            saveProfile();
            
            profileModal.classList.remove('active');
            showNotification('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'info');
            
            // Regenerate insights with new profile data
            if (workoutsData.length > 0) {
                generateInsights();
            }
        });

        async function handleFiles(files) {
            if (files.length === 0) return;
            
            document.getElementById('loading').classList.add('active');
            
            // Don't reset workoutsData, append to existing data
            const newWorkouts = [];

            for (let file of files) {
                try {
                    // Both TCX and GPX are XML text files
                    const text = await file.text();
                    const workout = parseWorkoutFile(text, file.name);
                    if (workout) {
                        newWorkouts.push(workout);
                        console.log('Parsed workout:', file.name, workout);
                    } else {
                        console.warn('Failed to parse:', file.name);
                    }
                } catch (error) {
                    console.error('Error reading file:', file.name, error);
                }
            }

            // Add new workouts to existing data
            const beforeCount = workoutsData.length;
            workoutsData = [...workoutsData, ...newWorkouts];
            const afterAddCount = workoutsData.length;

            document.getElementById('loading').classList.remove('active');
            
            if (newWorkouts.length > 0 && workoutsData.length > 0) {
                // Remove duplicates using a Map approach
                // This works even if same workout is uploaded in TCX and FIT formats
                const uniqueWorkouts = [];
                const seen = new Set();
                
                for (const workout of workoutsData) {
                    let isDuplicate = false;
                    
                    // Check if this workout is a duplicate of any we've already seen
                    for (let i = 0; i < uniqueWorkouts.length; i++) {
                        const existing = uniqueWorkouts[i];
                        
                        // Compare dates (within 1 minute tolerance)
                        const dateDiff = Math.abs(existing.date.getTime() - workout.date.getTime());
                        const sameDate = dateDiff < 60000; // 1 minute
                        
                        // Compare duration (within 5% tolerance or 30 seconds)
                        const durationDiff = Math.abs(existing.duration - workout.duration);
                        const sameDuration = durationDiff < 30 || (workout.duration > 0 && durationDiff / workout.duration < 0.05);
                        
                        // Compare calories (within 10% tolerance or 20 kcal)
                        const caloriesDiff = Math.abs(existing.calories - workout.calories);
                        const sameCalories = caloriesDiff < 20 || (workout.calories > 0 && caloriesDiff / workout.calories < 0.10);
                        
                        if (sameDate && sameDuration && sameCalories) {
                            isDuplicate = true;
                            console.log('Duplicate found:', workout.date, 'matches existing workout');
                            break;
                        }
                    }
                    
                    if (!isDuplicate) {
                        uniqueWorkouts.push(workout);
                    }
                }
                
                workoutsData = uniqueWorkouts;
                
                const finalCount = workoutsData.length;
                const duplicatesRemoved = afterAddCount - finalCount;
                
                console.log(`Loaded ${newWorkouts.length} files, ${duplicatesRemoved} duplicates removed. Total: ${finalCount} workouts`);
                
                if (duplicatesRemoved > 0) {
                    showNotification(`–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${duplicatesRemoved}`, 'info');
                }
                
                if (newWorkouts.length > 0) {
                    showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${newWorkouts.length} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫`, 'info');
                }
                
                workoutsData.sort((a, b) => b.date - a.date);
                updateDashboard();
                console.log('Dashboard updated');
                generateInsights();
                console.log('Insights generated');
                analyzeHeartRateZones();
                console.log('Heart rate zones analyzed');
                displayWeeklyProgress();
                console.log('Weekly progress displayed');
                displayBenchmarks();
                console.log('Benchmarks displayed');
            } else {
                console.error('No workouts were successfully parsed from the uploaded files');
                console.log('Files processed:', files.length);
                console.log('New workouts parsed:', newWorkouts.length);
                console.log('Details of parsing attempts:');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log(`File ${i + 1}: ${file.name}, Type: ${file.type}, Size: ${file.size}`);
                }
                
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã.');
            }
        }

        function parseWorkoutFile(text, filename) {
            try {
                if (filename.toLowerCase().endsWith('.tcx')) {
                    const result = parseTCX(text);
                    if (!result) {
                        console.error('TCX parsing returned null for:', filename);
                    }
                    return result;
                } else if (filename.toLowerCase().endsWith('.gpx')) {
                    const result = parseGPX(text);
                    if (!result) {
                        console.error('GPX parsing returned null for:', filename);
                    }
                    return result;
                }
                console.warn('Unknown file format:', filename);
                return null;
            } catch (error) {
                console.error('Error parsing file:', filename, error);
                return null;
            }
        }

        function parseTCX(text) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, 'text/xml');
            
            // Check for parsing errors
            const parserError = xml.querySelector('parsererror');
            if (parserError) {
                console.error('XML parsing error:', parserError.textContent);
                return null;
            }
            
            const activity = xml.querySelector('Activity');
            if (!activity) {
                console.warn('No Activity element found in TCX');
                return null;
            }

            const sport = activity.getAttribute('Sport') || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
            console.log('TCX Sport attribute:', activity.getAttribute('Sport'), '-> sport:', sport);
            const id = xml.querySelector('Id')?.textContent;
            const date = id ? new Date(id) : new Date();

            let totalTime = 0;
            let totalDistance = 0;
            let totalCalories = 0;
            let heartRates = [];
            let maxHeartRate = 0;
            let trackPoints = [];

            const laps = xml.querySelectorAll('Lap');
            
            if (laps.length === 0) {
                console.warn('No Lap elements found in TCX');
            }
            
            laps.forEach((lap, lapIndex) => {
                const lapTime = parseFloat(lap.querySelector('TotalTimeSeconds')?.textContent || 0);
                const lapDistance = parseFloat(lap.querySelector('DistanceMeters')?.textContent || 0);
                const lapCalories = parseFloat(lap.querySelector('Calories')?.textContent || 0);

                totalTime += lapTime;
                totalDistance += lapDistance;
                totalCalories += lapCalories;

                const points = lap.querySelectorAll('Trackpoint');
                points.forEach(point => {
                    const hr = parseInt(point.querySelector('HeartRateBpm Value')?.textContent || 0);
                    if (hr > 0) {
                        heartRates.push(hr);
                        maxHeartRate = Math.max(maxHeartRate, hr);
                    }

                    const time = point.querySelector('Time')?.textContent;
                    const speed = parseFloat(point.querySelector('Speed')?.textContent || 0);
                    
                    trackPoints.push({
                        time: time ? new Date(time) : null,
                        heartRate: hr,
                        speed: speed * 3.6 // m/s to km/h
                    });
                });
            });

            const avgHeartRate = heartRates.length > 0 
                ? Math.round(heartRates.reduce((a, b) => a + b, 0) / heartRates.length)
                : 0;

            // Validate that we have at least some data
            if (totalTime === 0 && totalCalories === 0) {
                console.warn('TCX file has no usable data');
                return null;
            }

            console.log('Successfully parsed TCX:', {
                date: date.toISOString(),
                duration: totalTime,
                calories: totalCalories,
                laps: laps.length
            });

            return {
                date,
                sport,
                duration: totalTime,
                distance: totalDistance,
                calories: totalCalories,
                avgHeartRate,
                maxHeartRate,
                heartRates,
                trackPoints
            };
        }

        function parseGPX(text) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, 'text/xml');
            
            const parserError = xml.querySelector('parsererror');
            if (parserError) {
                console.error('XML parsing error');
                return null;
            }
            
            const track = xml.querySelector('trk');
            if (!track) {
                console.warn('No track element found in GPX');
                return null;
            }

            const metadata = xml.querySelector('metadata');
            let date = null;
            if (metadata) {
                const timeElement = metadata.querySelector('time');
                if (timeElement) {
                    date = new Date(timeElement.textContent);
                    console.log('Date from metadata:', date.toISOString());
                }
            }

            // Get track name (sport type)
            // Zepp uses <n> tag, standard GPX uses <name>
            let nameElement = track.querySelector('name');
            if (!nameElement) {
                nameElement = track.querySelector('n');
            }
            
            let sport = '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
            if (nameElement) {
                const fullName = nameElement.textContent;
                console.log('GPX track full name:', fullName);
                
                // Extract sport from Zepp format: "20240722 Outdoor running"
                // or "20250124 Walking"
                const sportMatch = fullName.match(/\d{8}\s+(.+)/);
                if (sportMatch) {
                    sport = sportMatch[1]; // "Outdoor running" or "Walking"
                } else {
                    sport = fullName;
                }
            }
            
            console.log('GPX track name:', nameElement ? nameElement.textContent : 'not found', '-> sport:', sport);

            const trackPoints = xml.querySelectorAll('trkpt');
            if (trackPoints.length === 0) {
                console.warn('No track points found in GPX');
                return null;
            }

            console.log(`Found ${trackPoints.length} track points in GPX`);

            let heartRates = [];
            let maxHeartRate = 0;
            let totalDistance = 0;
            let startTime = null;
            let endTime = null;
            let points = [];
            let prevLat = null;
            let prevLon = null;

            trackPoints.forEach((trkpt, index) => {
                const lat = parseFloat(trkpt.getAttribute('lat'));
                const lon = parseFloat(trkpt.getAttribute('lon'));
                const timeElement = trkpt.querySelector('time');
                const time = timeElement ? new Date(timeElement.textContent) : null;
                
                if (index === 0 && time) startTime = time;
                if (time) endTime = time;

                let hr = 0;
                const extensions = trkpt.querySelector('extensions');
                if (extensions) {
                    const hrElement = extensions.querySelector('hr') || 
                                     extensions.querySelector('heartrate') ||
                                     extensions.querySelector('[*|hr]');
                    if (hrElement) hr = parseInt(hrElement.textContent);
                }

                if (hr > 0 && hr < 250) {
                    heartRates.push(hr);
                    maxHeartRate = Math.max(maxHeartRate, hr);
                }

                if (prevLat !== null && prevLon !== null) {
                    const R = 6371000;
                    const dLat = (lat - prevLat) * Math.PI / 180;
                    const dLon = (lon - prevLon) * Math.PI / 180;
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(prevLat * Math.PI/180) * Math.cos(lat * Math.PI/180) *
                            Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    totalDistance += R * c;
                }

                prevLat = lat;
                prevLon = lon;

                points.push({
                    time,
                    heartRate: hr,
                    speed: 0,
                    altitude: parseFloat(trkpt.querySelector('ele')?.textContent || 0)
                });
            });

            const duration = startTime && endTime ? (endTime - startTime) / 1000 : trackPoints.length * 2;
            const avgHeartRate = heartRates.length > 0 ? Math.round(heartRates.reduce((a,b) => a+b, 0) / heartRates.length) : 0;
            const weight = userProfile.weight || 70;
            const durationMinutes = duration / 60;
            const calories = avgHeartRate > 0 ? Math.round(((avgHeartRate * 0.6) - 20) * durationMinutes) : Math.round(durationMinutes * 7);

            if (!date && startTime) {
                date = startTime;
                console.log('Date from first trackpoint:', date.toISOString());
            }
            
            if (!date) {
                date = new Date();
                console.warn('No date in GPX file, using current date');
            }

            console.log('Successfully parsed GPX:', {
                date: date.toISOString(),
                duration: duration,
                calories: calories,
                avgHeartRate: avgHeartRate,
                trackPoints: trackPoints.length
            });

            return {
                date,
                sport,
                duration,
                distance: totalDistance,
                calories,
                avgHeartRate,
                maxHeartRate,
                heartRates,
                trackPoints: points
            };
        }

        function updateDashboard() {
            // Update summary cards
            const totalWorkouts = workoutsData.length;
            const totalCalories = workoutsData.reduce((sum, w) => sum + w.calories, 0);
            const totalTime = workoutsData.reduce((sum, w) => sum + w.duration, 0);
            const avgHeartRate = Math.round(
                workoutsData.reduce((sum, w) => sum + w.avgHeartRate, 0) / totalWorkouts
            );

            document.getElementById('totalWorkouts').textContent = totalWorkouts;
            document.getElementById('totalCalories').textContent = Math.round(totalCalories).toLocaleString();
            document.getElementById('avgHeartRate').textContent = avgHeartRate || '--';
            document.getElementById('totalTime').textContent = `${Math.round(totalTime / 3600)}—á`;

            // Update workouts list
            updateWorkoutsList();

            // Update charts
            updateCharts();

            // Show containers
            document.getElementById('chartsContainer').style.display = 'block';
            document.getElementById('heartRateContainer').style.display = 'block';
            
            // Show clear button
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.style.display = 'inline-block';
            }
            
            // Reset file input to allow re-uploading same files
            fileInput.value = '';
        }

        function updateWorkoutsList() {
            const listContainer = document.getElementById('workoutsList');
            listContainer.innerHTML = '<div class="chart-title">üìã –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>';

            workoutsData.forEach(workout => {
                const item = document.createElement('div');
                item.className = 'workout-item';
                
                const dateStr = workout.date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                const duration = Math.round(workout.duration / 60);
                const distance = (workout.distance / 1000).toFixed(2);
                
                // Map sport types to icons
                const sportIcons = {
                    'Running': 'üèÉ',
                    'Outdoor running': 'üèÉ',
                    'Indoor running': 'üèÉ',
                    'Treadmill': 'üèÉ',
                    'Biking': 'üö¥',
                    'Cycling': 'üö¥',
                    'Outdoor cycling': 'üö¥',
                    'Indoor cycling': 'üö¥',
                    'Walking': 'üö∂',
                    'Hiking': 'ü•æ',
                    'Swimming': 'üèä',
                    'Pool swimming': 'üèä',
                    'Open water swimming': 'üèä',
                    'Other': 'üè∏',
                    'Badminton': 'üè∏',
                    'Tennis': 'üéæ',
                    'Roller skating': '‚õ∏Ô∏è',
                    'Skiing': '‚õ∑Ô∏è',
                    'Cross-country skiing': '‚õ∑Ô∏è',
                    'Yoga': 'üßò',
                    'Strength training': 'üí™',
                    'Elliptical': 'üèãÔ∏è',
                    'Rowing': 'üö£',
                    'Jump rope': 'ü™¢',
                    'Cricket': 'üèè',
                    'Basketball': 'üèÄ',
                    'Football': '‚öΩ',
                    'Soccer': '‚öΩ'
                };
                
                const sportIcon = sportIcons[workout.sport] || 'üí™';
                const sportName = workout.sport || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';

                item.innerHTML = `
                    <div class="workout-date">
                        <span title="${sportName}">${sportIcon}</span> ${dateStr}
                    </div>
                    <div class="workout-stats">
                        <span class="stat-badge">‚è±Ô∏è ${duration} –º–∏–Ω</span>
                        <span class="stat-badge">üî• ${Math.round(workout.calories)} –∫–∫–∞–ª</span>
                        <span class="stat-badge">üíì ${workout.avgHeartRate} —É–¥/–º–∏–Ω</span>
                        ${workout.distance > 0 ? `<span class="stat-badge">üìç ${distance} –∫–º</span>` : ''}
                    </div>
                `;

                listContainer.appendChild(item);
            });
        }

        function updateCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // Workouts over time chart
            const workoutsByDate = {};
            workoutsData.forEach(workout => {
                const dateKey = workout.date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
                workoutsByDate[dateKey] = (workoutsByDate[dateKey] || 0) + 1;
            });

            const labels = Object.keys(workoutsByDate).slice(-14);
            const data = labels.map(label => workoutsByDate[label]);

            const ctx1 = document.getElementById('workoutsChart').getContext('2d');
            charts.workouts = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
                        data,
                        backgroundColor: 'rgba(0, 255, 136, 0.6)',
                        borderColor: 'rgba(0, 255, 136, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#8b9dc3',
                                stepSize: 1
                            },
                            grid: { color: '#2a3550' }
                        },
                        x: {
                            ticks: { color: '#8b9dc3' },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Heart rate chart
            const heartRateData = workoutsData.map((w, i) => ({
                x: i,
                y: w.avgHeartRate,
                label: w.date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' })
            }));

            const ctx2 = document.getElementById('heartRateChart').getContext('2d');
            charts.heartRate = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: heartRateData.map(d => d.label),
                    datasets: [{
                        label: '–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å',
                        data: heartRateData.map(d => d.y),
                        borderColor: '#ff3366',
                        backgroundColor: 'rgba(255, 51, 102, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#ff3366',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { color: '#8b9dc3' },
                            grid: { color: '#2a3550' }
                        },
                        x: {
                            ticks: { color: '#8b9dc3' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function generateInsights() {
            console.log('generateInsights() called');
            const insightsContainer = document.getElementById('insights');
            const insightsContent = document.getElementById('insightsContent');
            insightsContent.innerHTML = '';

            const insights = analyzeHealth();
            console.log('Generated', insights.length, 'insights');

            insights.forEach(insight => {
                const item = document.createElement('div');
                item.className = 'insight-item';
                item.innerHTML = `
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-content">
                        <h4>${insight.title}</h4>
                        <p>${insight.text}</p>
                    </div>
                `;
                insightsContent.appendChild(item);
            });

            if (insights.length > 0) {
                insightsContainer.style.display = 'block';
                insightsContainer.style.visibility = 'visible';
                console.log('Insights container shown');
            } else {
                console.warn('No insights generated!');
            }
        }

        function analyzeHealth() {
            const insights = [];
            const totalWorkouts = workoutsData.length;
            
            if (totalWorkouts === 0) return insights;

            const avgHeartRate = Math.round(
                workoutsData.reduce((sum, w) => sum + w.avgHeartRate, 0) / totalWorkouts
            );
            const totalCalories = workoutsData.reduce((sum, w) => sum + w.calories, 0);
            const avgCaloriesPerWorkout = Math.round(totalCalories / totalWorkouts);
            const totalTime = workoutsData.reduce((sum, w) => sum + w.duration, 0);

            // –ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
            const daysBetween = (workoutsData[0].date - workoutsData[totalWorkouts - 1].date) / (1000 * 60 * 60 * 24);
            const workoutsPerWeek = (totalWorkouts / daysBetween) * 7;

            if (workoutsPerWeek >= 3) {
                insights.push({
                    icon: '‚úÖ',
                    title: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å',
                    text: `–í—ã —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç–µ—Å—å ${workoutsPerWeek.toFixed(1)} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é. –≠—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ñ–æ—Ä–º—ã –∏ —Ä–∞–∑–≤–∏—Ç–∏—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏.`
                });
            } else if (workoutsPerWeek >= 2) {
                insights.push({
                    icon: '‚ö†Ô∏è',
                    title: '–£–≤–µ–ª–∏—á—å—Ç–µ —á–∞—Å—Ç–æ—Ç—É',
                    text: `–í—ã —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç–µ—Å—å ${workoutsPerWeek.toFixed(1)} —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é. –î–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 3-4 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –Ω–µ–¥–µ–ª—é.`
                });
            } else {
                insights.push({
                    icon: '‚ùó',
                    title: '–ù—É–∂–Ω–∞ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å',
                    text: '–°—Ç–∞—Ä–∞–π—Ç–µ—Å—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –º–∏–Ω–∏–º—É–º 2-3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Ñ–æ—Ä–º—ã.'
                });
            }

            // –ê–Ω–∞–ª–∏–∑ –ø—É–ª—å—Å–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ—Ñ–∏–ª—è
            if (userProfile.age) {
                const maxHR = calculateMaxHR(userProfile.age);
                const avgHRPercent = (avgHeartRate / maxHR * 100).toFixed(0);
                
                if (avgHRPercent >= 70 && avgHRPercent <= 85) {
                    insights.push({
                        icon: 'üíö',
                        title: '–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å',
                        text: `–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å ${avgHeartRate} —É–¥/–º–∏–Ω (${avgHRPercent}% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞—ç—Ä–æ–±–Ω–æ–π –∑–æ–Ω–µ, —á—Ç–æ –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏ –∏ —Å–∂–∏–≥–∞–Ω–∏—è –∂–∏—Ä–∞.`
                    });
                } else if (avgHRPercent > 85) {
                    insights.push({
                        icon: 'üî¥',
                        title: '–í—ã—Å–æ–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å',
                        text: `–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å ${avgHeartRate} —É–¥/–º–∏–Ω (${avgHRPercent}% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞) –¥–æ–≤–æ–ª—å–Ω–æ –≤—ã—Å–æ–∫. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –º–µ–∂–¥—É –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–º–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏.`
                    });
                } else {
                    insights.push({
                        icon: 'üíô',
                        title: '–£–º–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
                        text: `–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å ${avgHeartRate} —É–¥/–º–∏–Ω (${avgHRPercent}% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞). –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –ª—É—á—à–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.`
                    });
                }
            } else {
                // –ë–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è - –±–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
                if (avgHeartRate >= 140 && avgHeartRate <= 160) {
                    insights.push({
                        icon: 'üíö',
                        title: '–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å',
                        text: `–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å ${avgHeartRate} —É–¥/–º–∏–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞—ç—Ä–æ–±–Ω–æ–π –∑–æ–Ω–µ, —á—Ç–æ –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏ –∏ —Å–∂–∏–≥–∞–Ω–∏—è –∂–∏—Ä–∞.`
                    });
                } else if (avgHeartRate > 160) {
                    insights.push({
                        icon: 'üî¥',
                        title: '–í—ã—Å–æ–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å',
                        text: `–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å ${avgHeartRate} —É–¥/–º–∏–Ω –¥–æ–≤–æ–ª—å–Ω–æ –≤—ã—Å–æ–∫. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –º–µ–∂–¥—É –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–º–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏.`
                    });
                } else {
                    insights.push({
                        icon: 'üíô',
                        title: '–£–º–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
                        text: `–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å ${avgHeartRate} —É–¥/–º–∏–Ω. –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –ª—É—á—à–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.`
                    });
                }
            }

            // –ê–Ω–∞–ª–∏–∑ –∫–∞–ª–æ—Ä–∏–π —Å —É—á–µ—Ç–æ–º –≤–µ—Å–∞
            if (userProfile.weight) {
                const caloriesPerKg = avgCaloriesPerWorkout / userProfile.weight;
                if (caloriesPerKg >= 6) {
                    insights.push({
                        icon: 'üî•',
                        title: '–í—ã—Å–æ–∫–∏–π —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏',
                        text: `–í —Å—Ä–µ–¥–Ω–µ–º –≤—ã —Å–∂–∏–≥–∞–µ—Ç–µ ${avgCaloriesPerWorkout} –∫–∫–∞–ª –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É (${caloriesPerKg.toFixed(1)} –∫–∫–∞–ª/–∫–≥). –û—Ç–ª–∏—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å! –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.`
                    });
                } else {
                    insights.push({
                        icon: 'üí°',
                        title: '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Ä–æ—Å—Ç–∞',
                        text: `–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ ${avgCaloriesPerWorkout} –∫–∫–∞–ª –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É (${caloriesPerKg.toFixed(1)} –∫–∫–∞–ª/–∫–≥). –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∏–≥—Ä—ã.`
                    });
                }
            } else {
                // –ë–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è - –±–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
                if (avgCaloriesPerWorkout >= 400) {
                    insights.push({
                        icon: 'üî•',
                        title: '–í—ã—Å–æ–∫–∏–π —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏',
                        text: `–í —Å—Ä–µ–¥–Ω–µ–º –≤—ã —Å–∂–∏–≥–∞–µ—Ç–µ ${avgCaloriesPerWorkout} –∫–∫–∞–ª –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É. –û—Ç–ª–∏—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å! –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.`
                    });
                } else {
                    insights.push({
                        icon: 'üí°',
                        title: '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Ä–æ—Å—Ç–∞',
                        text: `–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ ${avgCaloriesPerWorkout} –∫–∫–∞–ª –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É. –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∏–≥—Ä—ã.`
                    });
                }
            }

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é
            const avgDuration = totalTime / totalWorkouts / 60;
            if (avgDuration > 60) {
                insights.push({
                    icon: 'üò¥',
                    title: '–í–∞–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è',
                    text: `–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ${Math.round(avgDuration)} –º–∏–Ω—É—Ç. –ü—Ä–∏ —Ç–∞–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–æ–Ω (7-9 —á–∞—Å–æ–≤) –∏ –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ –º–µ–∂–¥—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏.`
                });
            }

            // –ò–ú–¢ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            if (userProfile.weight && userProfile.height) {
                const bmi = calculateBMI(userProfile.weight, userProfile.height);
                const category = getBMICategory(bmi);
                
                if (category === '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π') {
                    insights.push({
                        icon: '‚öñÔ∏è',
                        title: '–ò–¥–µ–∞–ª—å–Ω—ã–π –≤–µ—Å',
                        text: `–í–∞—à –ò–ú–¢ ${bmi} –≤ –Ω–æ—Ä–º–µ. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –ø–∏—Ç–∞–Ω–∏—è.`
                    });
                } else if (category === '–ò–∑–±—ã—Ç–æ—á–Ω—ã–π' || category === '–û–∂–∏—Ä–µ–Ω–∏–µ') {
                    insights.push({
                        icon: 'üéØ',
                        title: '–§–æ–∫—É—Å –Ω–∞ —Å–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞',
                        text: `–í–∞—à –ò–ú–¢ ${bmi} (${category}). –ë–∞–¥–º–∏–Ω—Ç–æ–Ω - –æ—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –≤–µ—Å–∞! –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ—á–µ—Ç–∞—Ç—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–∏—Ç–∞–Ω–∏–µ–º –∏ —É–≤–µ–ª–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–æ 4-5 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é.`
                    });
                } else if (category === '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π') {
                    insights.push({
                        icon: 'üçΩÔ∏è',
                        title: '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
                        text: `–í–∞—à –ò–ú–¢ ${bmi} (${category}). –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –ø–∏—Ç–∞–Ω–∏—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã.`
                    });
                }
            }

            // –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è
            if (avgCaloriesPerWorkout > 300) {
                const waterNeeded = Math.round((avgDuration / 15) * 200);
                insights.push({
                    icon: 'üíß',
                    title: '–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ –≤–æ–¥–µ',
                    text: `–ü—Ä–∏ —Å—Ä–µ–¥–Ω–µ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –≤–∞—à–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–ø–∏–≤–∞—Ç—å –æ–∫–æ–ª–æ ${waterNeeded} –º–ª –≤–æ–¥—ã –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç –ø–æ 200 –º–ª).`
                });
            }

            // –ü–∏—Ç–∞–Ω–∏–µ
            if (avgCaloriesPerWorkout > 400) {
                insights.push({
                    icon: 'üçΩÔ∏è',
                    title: '–ü–∏—Ç–∞–Ω–∏–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è',
                    text: `–ü–æ—Å–ª–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (${avgCaloriesPerWorkout} –∫–∫–∞–ª) –≤–æ—Å–ø–æ–ª–Ω–∏—Ç–µ —ç–Ω–µ—Ä–≥–∏—é –≤ —Ç–µ—á–µ–Ω–∏–µ 30-60 –º–∏–Ω—É—Ç: —É–≥–ª–µ–≤–æ–¥—ã + –±–µ–ª–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–∞–Ω–∞–Ω + –ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –∫–æ–∫—Ç–µ–π–ª—å). –≠—Ç–æ —É—Å–∫–æ—Ä–∏—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º—ã—à—Ü.`
                });
            }

            if (avgDuration > 45) {
                insights.push({
                    icon: 'ü•ó',
                    title: '–ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π',
                    text: `–ó–∞ 1-2 —á–∞—Å–∞ –¥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å—ä–µ—à—å—Ç–µ –ª–µ–≥–∫–æ—É—Å–≤–æ—è–µ–º—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (–æ–≤—Å—è–Ω–∫–∞, –±–∞–Ω–∞–Ω, —Ç–æ—Å—Ç —Å –º—ë–¥–æ–º) –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ ${Math.round(avgDuration)} –º–∏–Ω—É—Ç –∏–≥—Ä—ã.`
                });
            }

            return insights;
        }

        // Heart Rate Zones Analysis
        function analyzeHeartRateZones() {
            console.log('analyzeHeartRateZones called, workouts:', workoutsData.length);
            if (workoutsData.length === 0) {
                console.log('No workouts, skipping HR zones');
                return;
            }

            const maxHR = userProfile.age ? calculateMaxHR(userProfile.age) : 190;
            console.log('Max HR:', maxHR, 'Age:', userProfile.age);
            
            const zones = [
                { name: '–û—Ç–¥—ã—Ö', min: 0, max: 0.5, color: 'zone-rest', benefit: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', time: 0 },
                { name: '–†–∞–∑–º–∏–Ω–∫–∞', min: 0.5, max: 0.6, color: 'zone-warmup', benefit: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –Ω–∞–≥—Ä—É–∑–∫–µ', time: 0 },
                { name: '–ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ', min: 0.6, max: 0.7, color: 'zone-fat', benefit: '–°–∂–∏–≥–∞–Ω–∏–µ –∂–∏—Ä–∞', time: 0 },
                { name: '–ê—ç—Ä–æ–±–Ω–∞—è', min: 0.7, max: 0.8, color: 'zone-aerobic', benefit: '–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å', time: 0 },
                { name: '–ê–Ω–∞—ç—Ä–æ–±–Ω–∞—è', min: 0.8, max: 0.9, color: 'zone-anaerobic', benefit: '–ú–æ—â–Ω–æ—Å—Ç—å', time: 0 },
                { name: '–ú–∞–∫—Å–∏–º—É–º', min: 0.9, max: 1.0, color: 'zone-max', benefit: '–ü–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞', time: 0 }
            ];

            // Calculate time in each zone
            let totalPoints = 0;
            workoutsData.forEach(workout => {
                if (workout.heartRates && workout.heartRates.length > 0) {
                    workout.heartRates.forEach(hr => {
                        totalPoints++;
                        const hrPercent = hr / maxHR;
                        
                        for (let zone of zones) {
                            if (hrPercent >= zone.min && hrPercent < zone.max) {
                                zone.time++;
                                break;
                            }
                        }
                    });
                }
            });

            if (totalPoints === 0) return;

            // Create visualization
            const zoneBar = document.getElementById('zoneBar');
            const zoneLegend = document.getElementById('zoneLegend');
            
            zoneBar.innerHTML = '';
            zoneLegend.innerHTML = '';

            zones.forEach(zone => {
                const percentage = (zone.time / totalPoints * 100);
                
                if (percentage > 0) {
                    // Bar segment
                    const segment = document.createElement('div');
                    segment.className = `zone-segment ${zone.color}`;
                    segment.style.width = `${percentage}%`;
                    segment.textContent = `${percentage.toFixed(0)}%`;
                    zoneBar.appendChild(segment);
                }

                // Legend item
                const item = document.createElement('div');
                item.className = 'zone-item';
                item.innerHTML = `
                    <div class="zone-color ${zone.color}"></div>
                    <div class="zone-info">
                        <div class="zone-name">${zone.name}</div>
                        <div class="zone-range">${Math.round(zone.min * maxHR)}-${Math.round(zone.max * maxHR)} —É–¥/–º–∏–Ω</div>
                        <div class="zone-time">${percentage.toFixed(1)}% –≤—Ä–µ–º–µ–Ω–∏</div>
                    </div>
                `;
                zoneLegend.appendChild(item);
            });

            document.getElementById('hrZones').style.display = 'block';
            console.log('HR Zones displayed with', zones.length, 'zones');
        }

        // Weekly Progress Analysis
        function analyzeWeeklyProgress() {
            console.log('analyzeWeeklyProgress called, workouts:', workoutsData.length);
            if (workoutsData.length < 2) {
                console.log('Not enough workouts for weekly progress (need at least 2)');
                return null;
            }

            // Group workouts by week
            const weekGroups = {};
            workoutsData.forEach(workout => {
                const weekStart = new Date(workout.date);
                // Set to Monday of the week (European standard)
                const day = weekStart.getDay();
                const diff = (day === 0 ? -6 : 1) - day; // Monday = 1, Sunday = 0 -> -6
                weekStart.setDate(weekStart.getDate() + diff);
                weekStart.setHours(0, 0, 0, 0);
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (!weekGroups[weekKey]) {
                    weekGroups[weekKey] = [];
                }
                weekGroups[weekKey].push(workout);
            });

            const weeks = Object.keys(weekGroups).sort().reverse().slice(0, 4);
            if (weeks.length < 2) {
                console.log('Not enough weeks for comparison, need at least 2 different weeks');
                return null;
            }
            
            console.log('Weeks found:', weeks);
            console.log('Week groups:', weekGroups);

            const weekStats = weeks.map(weekKey => {
                const workouts = weekGroups[weekKey];
                return {
                    week: weekKey,
                    count: workouts.length,
                    totalCalories: workouts.reduce((sum, w) => sum + w.calories, 0),
                    avgHeartRate: workouts.reduce((sum, w) => sum + w.avgHeartRate, 0) / workouts.length,
                    totalTime: workouts.reduce((sum, w) => sum + w.duration, 0) / 3600
                };
            });

            return weekStats;
        }

        function displayWeeklyProgress() {
            console.log('displayWeeklyProgress called');
            const weekStats = analyzeWeeklyProgress();
            if (!weekStats) {
                console.log('No week stats returned, skipping weekly progress');
                return;
            }

            console.log('Week stats:', weekStats);
            const progressGrid = document.getElementById('progressGrid');
            progressGrid.innerHTML = '<div class="chart-title" style="grid-column: 1/-1;">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –Ω–µ–¥–µ–ª—è–º</div>';

            // This week vs last week
            const thisWeek = weekStats[0];
            const lastWeek = weekStats[1];

            const metrics = [
                {
                    title: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
                    current: thisWeek.count,
                    previous: lastWeek.count,
                    unit: '—Ä–∞–∑',
                    format: (v) => Math.round(v)
                },
                {
                    title: '–ö–∞–ª–æ—Ä–∏–∏',
                    current: thisWeek.totalCalories,
                    previous: lastWeek.totalCalories,
                    unit: '–∫–∫–∞–ª',
                    format: (v) => Math.round(v)
                },
                {
                    title: '–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å',
                    current: thisWeek.avgHeartRate,
                    previous: lastWeek.avgHeartRate,
                    unit: '—É–¥/–º–∏–Ω',
                    format: (v) => Math.round(v)
                },
                {
                    title: '–í—Ä–µ–º—è',
                    current: thisWeek.totalTime,
                    previous: lastWeek.totalTime,
                    unit: '—á',
                    format: (v) => v.toFixed(1)
                }
            ];

            metrics.forEach(metric => {
                const change = ((metric.current - metric.previous) / metric.previous * 100);
                const trend = change > 5 ? 'up' : change < -5 ? 'down' : 'stable';
                const trendIcon = change > 5 ? 'üìà' : change < -5 ? 'üìâ' : '‚û°Ô∏è';

                const card = document.createElement('div');
                card.className = 'progress-card';
                card.innerHTML = `
                    <div class="progress-title">${metric.title} (—ç—Ç–∞ –Ω–µ–¥–µ–ª—è)</div>
                    <div class="progress-value">${metric.format(metric.current)}<span style="font-size: 1.5rem; color: var(--text-dim);"> ${metric.unit}</span></div>
                    <div class="progress-trend ${trend}">${trendIcon} ${change > 0 ? '+' : ''}${change.toFixed(0)}% –æ—Ç –ø—Ä–æ—à–ª–æ–π</div>
                `;
                progressGrid.appendChild(card);
            });

            progressGrid.style.display = 'grid';
        }

        // Benchmarks and Comparisons
        function displayBenchmarks() {
            console.log('displayBenchmarks() called, workouts:', workoutsData.length);
            if (workoutsData.length === 0) {
                console.log('No workouts, skipping benchmarks');
                return;
            }

            const benchmarksContent = document.getElementById('benchmarksContent');
            benchmarksContent.innerHTML = '';
            console.log('Benchmarks content cleared, generating...');

            // Personal bests
            const maxCalories = Math.max(...workoutsData.map(w => w.calories));
            const maxDuration = Math.max(...workoutsData.map(w => w.duration));

            // Recent averages (last 5 workouts)
            const recent = workoutsData.slice(0, Math.min(5, workoutsData.length));
            const recentAvgCalories = recent.reduce((sum, w) => sum + w.calories, 0) / recent.length;
            const recentAvgDuration = recent.reduce((sum, w) => sum + w.duration, 0) / recent.length;

            const benchmarks = [
                {
                    label: '–ö–∞–ª–æ—Ä–∏–∏ –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É',
                    current: Math.round(recentAvgCalories),
                    best: Math.round(maxCalories),
                    unit: '–∫–∫–∞–ª'
                },
                {
                    label: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
                    current: Math.round(recentAvgDuration / 60),
                    best: Math.round(maxDuration / 60),
                    unit: '–º–∏–Ω'
                }
            ];

            // Age-based benchmarks if profile exists
            if (userProfile.age) {
                const avgCaloriesForAge = userProfile.age < 30 ? 500 : userProfile.age < 50 ? 450 : 400;

                benchmarks.push({
                    label: '–ö–∞–ª–æ—Ä–∏–∏ vs —Å—Ä–µ–¥–Ω–∏–µ –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞',
                    current: Math.round(recentAvgCalories),
                    best: avgCaloriesForAge,
                    unit: '–∫–∫–∞–ª',
                    isComparison: true
                });
            }

            benchmarks.forEach(benchmark => {
                const percentage = (benchmark.current / benchmark.best * 100);
                const card = document.createElement('div');
                card.className = 'benchmark-card';
                
                const comparison = benchmark.isComparison 
                    ? `–°—Ä–µ–¥–Ω–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞: ${benchmark.best} ${benchmark.unit}`
                    : `–í–∞—à –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${benchmark.best} ${benchmark.unit}`;

                card.innerHTML = `
                    <div class="benchmark-header">
                        <div class="benchmark-label">${benchmark.label}</div>
                        <div style="font-weight: 700; color: var(--accent-primary);">${benchmark.current} ${benchmark.unit}</div>
                    </div>
                    <div class="benchmark-bar">
                        <div class="benchmark-fill" style="width: ${Math.min(percentage, 100)}%">
                            <div class="benchmark-value">${percentage.toFixed(0)}%</div>
                        </div>
                    </div>
                    <div class="benchmark-comparison">${comparison}</div>
                `;
                benchmarksContent.appendChild(card);
            });

            // Forecast
            if (workoutsData.length >= 4) {
                const forecast = generateForecast();
                if (forecast) {
                    const forecastCard = document.createElement('div');
                    forecastCard.className = 'benchmark-card';
                    forecastCard.style.background = 'rgba(0, 255, 136, 0.05)';
                    forecastCard.style.borderColor = 'var(--accent-primary)';
                    forecastCard.innerHTML = `
                        <div class="benchmark-header">
                            <div class="benchmark-label">üîÆ –ü—Ä–æ–≥–Ω–æ–∑ —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü</div>
                        </div>
                        <div style="color: var(--text-secondary); line-height: 1.6; margin-top: 0.5rem;">
                            ${forecast}
                        </div>
                    `;
                    benchmarksContent.appendChild(forecastCard);
                }
            }

            document.getElementById('benchmarksSection').style.display = 'block';
            console.log('Benchmarks section displayed');
        }

        function generateForecast() {
            if (workoutsData.length < 4) return null;

            // Calculate trends
            const recentHalf = workoutsData.slice(0, Math.floor(workoutsData.length / 2));
            const olderHalf = workoutsData.slice(Math.floor(workoutsData.length / 2));

            const recentAvgCalories = recentHalf.reduce((sum, w) => sum + w.calories, 0) / recentHalf.length;
            const olderAvgCalories = olderHalf.reduce((sum, w) => sum + w.calories, 0) / olderHalf.length;

            const caloriesTrend = ((recentAvgCalories - olderAvgCalories) / olderAvgCalories * 100);

            const recentFrequency = recentHalf.length;
            const olderFrequency = olderHalf.length;

            let forecast = '';

            if (caloriesTrend > 10) {
                const projectedCalories = Math.round(recentAvgCalories * 1.15);
                forecast += `–ü—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ —Ä–æ—Å—Ç–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏, —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü –≤—ã –±—É–¥–µ—Ç–µ —Å–∂–∏–≥–∞—Ç—å –æ–∫–æ–ª–æ <strong style="color: var(--accent-primary);">${projectedCalories} –∫–∫–∞–ª</strong> –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É. `;
            } else if (caloriesTrend < -10) {
                forecast += `–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å–Ω–∏–∂–∞–µ—Ç—Å—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ —Ç–µ–º–ø –∏–≥—Ä—ã. `;
            } else {
                forecast += `–í—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. `;
            }

            if (recentFrequency > olderFrequency) {
                forecast += `–ß–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Ä–∞—Å—Ç—ë—Ç ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è —Ç–µ–Ω–¥–µ–Ω—Ü–∏—è! `;
            }

            const monthlyCalories = Math.round(recentAvgCalories * recentFrequency * 4);
            forecast += `–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞—Å—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü: <strong style="color: var(--accent-primary);">${monthlyCalories.toLocaleString()} –∫–∫–∞–ª</strong>.`;

            return forecast;
        }
    </script>
</body>
</html>